#!ipxe

echo In inspector.ipxe
{% if env.DEPLOY_KERNEL_BY_ARCH is defined %}
{#- Parse DEPLOY_KERNEL_BY_ARCH and DEPLOY_RAMDISK_BY_ARCH into dictionaries -#}
{%- set file_url_prefix = 'file:///shared/html/' -%}
{%- set kernel_by_arch = {} -%}
{%- for item in env.DEPLOY_KERNEL_BY_ARCH.split(',') -%}
{%- set arch = item.split(':')[0] -%}
{%- set url = item.split(':', 1)[1] | replace(file_url_prefix, env.IRONIC_HTTP_URL + '/') -%}
{%- set _ = kernel_by_arch.update({arch: url}) -%}
{%- endfor -%}
{%- set ramdisk_by_arch = {} -%}
{%- for item in env.DEPLOY_RAMDISK_BY_ARCH.split(',') -%}
{%- set arch = item.split(':')[0] -%}
{%- set url = item.split(':', 1)[1] | replace(file_url_prefix, env.IRONIC_HTTP_URL + '/') -%}
{%- set _ = ramdisk_by_arch.update({arch: url}) -%}
{%- endfor -%}
# Architecture-specific boot selection
# NOTE: iPXE uses 'arm64' but env vars use 'aarch64'
iseq ${buildarch} arm64 && goto arm64 ||
iseq ${buildarch} x86_64 && goto x86_64 ||
goto fallback

:arm64
echo Booting aarch64 IPA
set ipa_kernel {{ kernel_by_arch.get('aarch64', '') }}
set ipa_ramdisk {{ ramdisk_by_arch.get('aarch64', '') }}
set ipa_ramdisk_name {{ ramdisk_by_arch.get('aarch64', '').split('/')[-1] }}
goto boot

:x86_64
echo Booting x86_64 IPA
set ipa_kernel {{ kernel_by_arch.get('x86_64', '') }}
set ipa_ramdisk {{ ramdisk_by_arch.get('x86_64', '') }}
set ipa_ramdisk_name {{ ramdisk_by_arch.get('x86_64', '').split('/')[-1] }}
goto boot

:fallback
echo Booting fallback IPA for ${buildarch}
set ipa_kernel {{ env.IRONIC_HTTP_URL }}/images/ironic-python-agent.kernel
set ipa_ramdisk {{ env.IRONIC_HTTP_URL }}/images/ironic-python-agent.initramfs
set ipa_ramdisk_name ironic-python-agent.initramfs
goto boot

:boot
:retry_boot
imgfree
# NOTE(dtantsur): keep inspection kernel params in [mdns]params in
# ironic-inspector-image and configuration in configure-ironic.sh
kernel --timeout 60000 ${ipa_kernel} ipa-insecure=1 ipa-inspection-collectors={{ env.IRONIC_IPA_COLLECTORS }} systemd.journald.forward_to_console={{ env.IPA_FORWARD_CONSOLE | default('yes') }} BOOTIF=${mac} ipa-debug=1 ipa-enable-vlan-interfaces={{ env.IRONIC_ENABLE_VLAN_INTERFACES }} ipa-inspection-dhcp-all-interfaces=1 ipa-collect-lldp=1 {{ env.INSPECTOR_EXTRA_ARGS }} initrd=${ipa_ramdisk_name} {% if env.IRONIC_RAMDISK_SSH_KEY %}sshkey="{{ env.IRONIC_RAMDISK_SSH_KEY|trim }}"{% endif %} {{ env.IRONIC_KERNEL_PARAMS|trim }} || goto retry_boot
initrd --timeout 60000 ${ipa_ramdisk} || goto retry_boot
boot
{% else %}
:retry_boot
imgfree
# NOTE(dtantsur): keep inspection kernel params in [mdns]params in
# ironic-inspector-image and configuration in configure-ironic.sh
kernel --timeout 60000 {{ env.IRONIC_HTTP_URL }}/images/ironic-python-agent.kernel ipa-insecure=1 ipa-inspection-collectors={{ env.IRONIC_IPA_COLLECTORS }} systemd.journald.forward_to_console={{ env.IPA_FORWARD_CONSOLE | default('yes') }} BOOTIF=${mac} ipa-debug=1 ipa-enable-vlan-interfaces={{ env.IRONIC_ENABLE_VLAN_INTERFACES }} ipa-inspection-dhcp-all-interfaces=1 ipa-collect-lldp=1 {{ env.INSPECTOR_EXTRA_ARGS }} initrd=ironic-python-agent.initramfs {% if env.IRONIC_RAMDISK_SSH_KEY %}sshkey="{{ env.IRONIC_RAMDISK_SSH_KEY|trim }}"{% endif %} {{ env.IRONIC_KERNEL_PARAMS|trim }} || goto retry_boot
initrd --timeout 60000 {{ env.IRONIC_HTTP_URL }}/images/ironic-python-agent.initramfs || goto retry_boot
boot
{% endif %}
