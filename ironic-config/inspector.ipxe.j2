#!ipxe

# Detect CPU architecture for multi-arch support.
# iPXE's ${buildarch} is "arm64" on aarch64, "x86_64" on x86.
# Set arch_suffix for selecting architecture-specific IPA images.
iseq ${buildarch} arm64 && set arch_suffix _aarch64 || set arch_suffix

:retry_boot
imgfree
# NOTE(dtantsur): keep inspection kernel params in [mdns]params in
# ironic-image and configuration in configure-ironic.sh
# NOTE: IRONIC_KERNEL_PARAMS contains CoreOS params including coreos.live.rootfs_url.
# We add the arch-specific coreos.live.rootfs_url at the END to override (kernel uses last occurrence).
kernel --timeout 60000 {{ env.IRONIC_HTTP_URL }}/images/ironic-python-agent${arch_suffix}.kernel console=ttyS0,115200 rd.net.timeout.carrier=30 ip=dhcp ipa-insecure=1 ipa-inspection-collectors={{ env.IRONIC_IPA_COLLECTORS }} systemd.journald.forward_to_console=yes BOOTIF=${mac} ipa-debug=1 ipa-enable-vlan-interfaces={{ env.IRONIC_ENABLE_VLAN_INTERFACES }} ipa-inspection-dhcp-all-interfaces=1 ipa-collect-lldp=1 {{ env.INSPECTOR_EXTRA_ARGS }} initrd=ironic-python-agent${arch_suffix}.initramfs {% if env.IRONIC_RAMDISK_SSH_KEY %}sshkey="{{ env.IRONIC_RAMDISK_SSH_KEY|trim }}"{% endif %} {{ env.IRONIC_KERNEL_PARAMS|trim }} coreos.live.rootfs_url={{ env.IRONIC_HTTP_URL }}/images/ironic-python-agent${arch_suffix}.rootfs || goto retry_boot
initrd --timeout 60000 {{ env.IRONIC_HTTP_URL }}/images/ironic-python-agent${arch_suffix}.initramfs || goto retry_boot
boot
